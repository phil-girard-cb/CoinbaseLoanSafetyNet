<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repay Loan - Loan Safety Net</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.0/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem 0;
        }
        .param-value {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            word-break: break-all;
        }
        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .balance-display {
            font-weight: bold;
            color: #28a745;
        }
        .conversion-display {
            font-size: 0.9em;
            color: #6c757d;
        }
        .loading-spinner {
            display: none;
        }
    </style>
</head>
<body>
    <div class="hero-section">
        <div class="container">
            <h1 class="display-5 text-center mb-3">Repay Loan</h1>
            <p class="lead text-center">Connect your wallet to repay this Morpho loan</p>
        </div>
    </div>

    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Repay Loan</li>
                    </ol>
                </nav>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0">Loan Details</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Loan Token:</label>
                                <div class="param-value" id="loan-token">Loading...</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Collateral Token:</label>
                                <div class="param-value" id="collateral-token">Loading...</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Oracle:</label>
                                <div class="param-value" id="oracle">Loading...</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">IRM:</label>
                                <div class="param-value" id="irm">Loading...</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">LLTV:</label>
                                <div class="param-value" id="lltv">Loading...</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Market ID:</label>
                                <div class="param-value" id="market-id">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Wallet Connection Section -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h3 class="mb-0">Wallet Connection</h3>
                    </div>
                    <div class="card-body">
                        <div id="wallet-disconnected" class="text-center">
                            <p class="text-muted mb-3">Connect your wallet to proceed with repayment</p>
                            <button id="connect-wallet-btn" class="btn btn-primary btn-lg">Connect Wallet</button>
                        </div>
                        <div id="wallet-connected" class="d-none">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Connected Address:</label>
                                    <div class="wallet-address" id="wallet-address">Not connected</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Network:</label>
                                    <div id="network-status">Checking...</div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">USDC Balance:</label>
                                    <div class="balance-display" id="usdc-balance">Loading...</div>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button id="disconnect-wallet-btn" class="btn btn-outline-secondary">Disconnect</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Repayment Section -->
                <div class="card mt-4" id="repayment-section" style="display: none;">
                    <div class="card-header">
                        <h3 class="mb-0">Repay Loan</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="alert alert-info">
                                <strong>Step 1:</strong> Enter the address that has the loan to repay
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="borrower-address" class="form-label fw-bold">Borrower Address</label>
                            <input type="text" class="form-control" id="borrower-address" placeholder="0x..." maxlength="42">
                            <div class="form-text">Enter the Ethereum address that has the loan position</div>
                        </div>

                        <div class="mb-3" id="loan-balance-section" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <label class="form-label fw-bold">Loan Balance:</label>
                                    <div class="balance-display text-danger" id="loan-balance">Loading...</div>
                                </div>
                                <button id="refresh-balance-btn" class="btn btn-sm btn-outline-primary">
                                    <span id="refresh-spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="alert alert-secondary">
                                <strong>Step 2:</strong> Enter repayment amount after confirming loan balance
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="repay-amount" class="form-label fw-bold">Repayment Amount (USD)</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="repay-amount" placeholder="0.00" min="0" step="0.01" disabled>
                            </div>
                            <div class="conversion-display mt-1" id="usdc-conversion">0 USDC</div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="alert alert-warning">
                                <strong>Step 3:</strong> Approve USDC spending to the Morpho contract
                            </div>
                        </div>

                        <button id="approve-usdc-btn" class="btn btn-success btn-lg w-100 mb-3" disabled>
                            <span class="loading-spinner spinner-border spinner-border-sm me-2" role="status"></span>
                            Approve USDC Spending
                        </button>

                        <div class="mb-3" id="repay-step-section" style="display: none;">
                            <div class="alert alert-success">
                                <strong>Step 4:</strong> Repay the loan with approved USDC
                            </div>
                        </div>

                        <button id="repay-loan-btn" class="btn btn-primary btn-lg w-100" disabled style="display: none;">
                            <span id="repay-spinner" class="spinner-border spinner-border-sm me-2" role="status" style="display: none;"></span>
                            Repay Loan
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Parse URL parameters and display them
        const urlParams = new URLSearchParams(window.location.search);
        
        document.getElementById('loan-token').textContent = urlParams.get('loan_token') || 'Not specified';
        document.getElementById('collateral-token').textContent = urlParams.get('collateral_token') || 'Not specified';
        document.getElementById('oracle').textContent = urlParams.get('oracle') || 'Not specified';
        document.getElementById('irm').textContent = urlParams.get('irm') || 'Not specified';
        document.getElementById('lltv').textContent = urlParams.get('lltv') || 'Not specified';
        document.getElementById('market-id').textContent = urlParams.get('market_id') || 'Not specified';

        // Web3 Configuration
        const BASE_CHAIN_ID = 8453;
        const USDC_ADDRESS = urlParams.get('loan_token') || '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';
        const MORPHO_ADDRESS = '0xBBBBBbbBBb9cC5e90e3b3Af64bdAF62C37EEFFCb';
        const MARKET_ID = urlParams.get('market_id') || '0x9103c3b4e834476c9a62ea009ba2c884ee42e94e6e314a26f04d312434191836';
        const USDC_DECIMALS = 6;

        // Global variables
        let provider = null;
        let signer = null;
        let userAddress = null;
        let usdcContract = null;
        let morphoContract = null;

        // USDC ABI for approve and balanceOf functions
        const USDC_ABI = [
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function balanceOf(address account) external view returns (uint256)",
            "function decimals() external view returns (uint8)"
        ];

        // Morpho ABI for position and repay functions
        const MORPHO_ABI = [
            "function position(bytes32 id, address user) external view returns (uint256 supplyShares, uint128 borrowShares, uint128 collateral)",
            "function repay(tuple(address loanToken, address collateralToken, address oracle, address irm, uint256 lltv) marketParams, uint256 assets, uint256 shares, address onBehalf, bytes data) external returns (uint256, uint256)"
        ];

        // DOM Elements
        const connectWalletBtn = document.getElementById('connect-wallet-btn');
        const disconnectWalletBtn = document.getElementById('disconnect-wallet-btn');
        const walletDisconnected = document.getElementById('wallet-disconnected');
        const walletConnected = document.getElementById('wallet-connected');
        const walletAddress = document.getElementById('wallet-address');
        const networkStatus = document.getElementById('network-status');
        const usdcBalance = document.getElementById('usdc-balance');
        const borrowerAddressInput = document.getElementById('borrower-address');
        const loanBalanceSection = document.getElementById('loan-balance-section');
        const loanBalance = document.getElementById('loan-balance');
        const refreshBalanceBtn = document.getElementById('refresh-balance-btn');
        const refreshSpinner = document.getElementById('refresh-spinner');
        const repaymentSection = document.getElementById('repayment-section');
        const repayAmountInput = document.getElementById('repay-amount');
        const usdcConversion = document.getElementById('usdc-conversion');
        const approveUsdcBtn = document.getElementById('approve-usdc-btn');
        const repayStepSection = document.getElementById('repay-step-section');
        const repayLoanBtn = document.getElementById('repay-loan-btn');
        const repaySpinner = document.getElementById('repay-spinner');

        // Event Listeners
        connectWalletBtn.addEventListener('click', connectWallet);
        disconnectWalletBtn.addEventListener('click', disconnectWallet);
        borrowerAddressInput.addEventListener('input', handleAddressInput);
        refreshBalanceBtn.addEventListener('click', refreshLoanBalance);
        repayAmountInput.addEventListener('input', updateConversion);
        approveUsdcBtn.addEventListener('click', approveUSDC);
        repayLoanBtn.addEventListener('click', repayLoan);

        // Connect Wallet Function
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    Swal.fire({
                        icon: 'error',
                        title: 'MetaMask Not Found',
                        text: 'Please install MetaMask to continue',
                    });
                    return;
                }

                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                // Check network
                const network = await provider.getNetwork();
                if (Number(network.chainId) !== BASE_CHAIN_ID) {
                    await switchToBase();
                    return;
                }

                // Initialize contracts
                usdcContract = new ethers.Contract(USDC_ADDRESS, USDC_ABI, signer);
                morphoContract = new ethers.Contract(MORPHO_ADDRESS, MORPHO_ABI, signer);

                // Update UI
                updateWalletUI();
                await updateBalance();

            } catch (error) {
                console.error('Wallet connection error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Connection Failed',
                    text: error.message || 'Failed to connect wallet',
                });
            }
        }

        // Switch to Base Network
        async function switchToBase() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x2105' }], // Base chainId in hex
                });
                // Retry connection after network switch
                setTimeout(connectWallet, 1000);
            } catch (error) {
                if (error.code === 4902) {
                    // Network not added, add it
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x2105',
                                chainName: 'Base',
                                nativeCurrency: {
                                    name: 'Ethereum',
                                    symbol: 'ETH',
                                    decimals: 18
                                },
                                rpcUrls: ['https://mainnet.base.org'],
                                blockExplorerUrls: ['https://basescan.org']
                            }]
                        });
                        setTimeout(connectWallet, 1000);
                    } catch (addError) {
                        console.error('Error adding Base network:', addError);
                        Swal.fire({
                            icon: 'error',
                            title: 'Network Error',
                            text: 'Please manually switch to Base network in your wallet',
                        });
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Network Switch Failed',
                        text: 'Please manually switch to Base network in your wallet',
                    });
                }
            }
        }

        // Update Wallet UI
        function updateWalletUI() {
            walletDisconnected.classList.add('d-none');
            walletConnected.classList.remove('d-none');
            repaymentSection.style.display = 'block';
            
            walletAddress.textContent = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
            networkStatus.innerHTML = '<span class="badge bg-success">Base Network</span>';
        }

        // Update USDC Balance
        async function updateBalance() {
            try {
                const balance = await usdcContract.balanceOf(userAddress);
                const balanceFormatted = ethers.formatUnits(balance, USDC_DECIMALS);
                usdcBalance.textContent = `$${parseFloat(balanceFormatted).toFixed(2)}`;
            } catch (error) {
                console.error('Balance update error:', error);
                usdcBalance.textContent = 'Error loading balance';
            }
        }

        // Handle Address Input
        async function handleAddressInput() {
            const address = borrowerAddressInput.value.trim();
            
            // Basic address validation
            if (address.length === 42 && address.startsWith('0x')) {
                try {
                    // Show loan balance section and fetch balance
                    loanBalanceSection.style.display = 'block';
                    loanBalance.textContent = 'Loading...';
                    await updateLoanBalance(address);
                    
                    // Enable repayment amount input
                    repayAmountInput.disabled = false;
                    updateConversion(); // Update button state
                } catch (error) {
                    console.error('Address validation error:', error);
                    loanBalance.textContent = 'Error loading loan balance';
                    updateConversion(); // Update button state
                }
            } else {
                // Hide loan balance section and disable repayment amount
                loanBalanceSection.style.display = 'none';
                repayAmountInput.disabled = true;
                repayAmountInput.value = '';
                usdcConversion.textContent = '0 USDC';
                updateConversion(); // Update button state
            }
        }

        // Update Loan Balance
        async function updateLoanBalance(targetAddress = null) {
            try {
                const addressToCheck = targetAddress || borrowerAddressInput.value.trim();
                
                if (!addressToCheck || !morphoContract) {
                    throw new Error('No address provided or contract not initialized');
                }

                const position = await morphoContract.position(MARKET_ID, addressToCheck);
                const borrowShares = position.borrowShares;
                loanBalance.textContent = `${borrowShares.toString()} shares`;
            } catch (error) {
                console.error('Loan balance update error:', error);
                loanBalance.textContent = 'Error loading loan balance';
            }
        }

        // Refresh Loan Balance
        async function refreshLoanBalance() {
            try {
                refreshSpinner.classList.remove('d-none');
                refreshBalanceBtn.disabled = true;
                await updateLoanBalance();
                updateConversion(); // Update button state after refresh
            } catch (error) {
                console.error('Refresh error:', error);
            } finally {
                refreshSpinner.classList.add('d-none');
                refreshBalanceBtn.disabled = false;
            }
        }

        // Update Conversion Display
        function updateConversion() {
            const dollarAmount = parseFloat(repayAmountInput.value) || 0;
            const usdcAmount = dollarAmount * Math.pow(10, USDC_DECIMALS);
            usdcConversion.textContent = `${dollarAmount.toFixed(6)} USDC`;
            
            // Enable/disable approve button - require valid address, loan balance, amount, and connected wallet
            const hasValidAddress = borrowerAddressInput.value.trim().length === 42 && borrowerAddressInput.value.trim().startsWith('0x');
            const hasLoanBalance = loanBalanceSection.style.display !== 'none' && !loanBalance.textContent.includes('Error');
            approveUsdcBtn.disabled = dollarAmount <= 0 || !userAddress || !hasValidAddress || !hasLoanBalance;
        }

        // Approve USDC Spending
        async function approveUSDC() {
            try {
                const dollarAmount = parseFloat(repayAmountInput.value);
                if (!dollarAmount || dollarAmount <= 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Invalid Amount',
                        text: 'Please enter a valid repayment amount',
                    });
                    return;
                }

                // Convert to USDC units (6 decimals)
                const usdcAmount = ethers.parseUnits(dollarAmount.toString(), USDC_DECIMALS);

                // Show loading state
                approveUsdcBtn.disabled = true;
                document.querySelector('.loading-spinner').style.display = 'inline-block';
                approveUsdcBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Approving...';

                // Execute approval transaction
                const tx = await usdcContract.approve(MORPHO_ADDRESS, usdcAmount);
                
                Swal.fire({
                    icon: 'info',
                    title: 'Transaction Submitted',
                    text: 'Please wait for confirmation...',
                    showConfirmButton: false,
                    timer: 3000
                });

                // Wait for transaction confirmation
                const receipt = await tx.wait();

                if (receipt.status === 1) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Approval Successful!',
                        text: `Successfully approved $${dollarAmount.toFixed(2)} USDC spending`,
                        footer: `<a href="https://basescan.org/tx/${receipt.hash}" target="_blank">View on BaseScan</a>`
                    });

                    // Enable repay functionality
                    repayStepSection.style.display = 'block';
                    repayLoanBtn.style.display = 'block';
                    repayLoanBtn.disabled = false;
                } else {
                    throw new Error('Transaction failed');
                }

            } catch (error) {
                console.error('Approval error:', error);
                let errorMessage = 'Approval transaction failed';
                
                if (error.code === 4001) {
                    errorMessage = 'Transaction rejected by user';
                } else if (error.message) {
                    errorMessage = error.message;
                }

                Swal.fire({
                    icon: 'error',
                    title: 'Approval Failed',
                    text: errorMessage,
                });
            } finally {
                // Reset button state
                approveUsdcBtn.disabled = false;
                approveUsdcBtn.innerHTML = 'Approve USDC Spending';
            }
        }

        // Repay Loan Function
        async function repayLoan() {
            try {
                const dollarAmount = parseFloat(repayAmountInput.value);
                const borrowerAddress = borrowerAddressInput.value.trim();
                
                if (!dollarAmount || dollarAmount <= 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Invalid Amount',
                        text: 'Please enter a valid repayment amount',
                    });
                    return;
                }

                if (!borrowerAddress) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Missing Address',
                        text: 'Please enter the borrower address',
                    });
                    return;
                }

                // Convert to USDC units (6 decimals)
                const usdcAmount = ethers.parseUnits(dollarAmount.toString(), USDC_DECIMALS);

                // Show loading state
                repayLoanBtn.disabled = true;
                repaySpinner.style.display = 'inline-block';
                repayLoanBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Repaying...';

                // Construct market parameters from URL params
                const marketParams = {
                    loanToken: urlParams.get('loan_token'),
                    collateralToken: urlParams.get('collateral_token'),
                    oracle: urlParams.get('oracle'),
                    irm: urlParams.get('irm'),
                    lltv: urlParams.get('lltv')
                };

                // Execute repay transaction
                const tx = await morphoContract.repay(
                    marketParams,    // MarketParams struct
                    usdcAmount,      // assets to repay
                    0,               // shares (0 means repay by assets amount)
                    borrowerAddress, // onBehalf (address to repay for)
                    "0x"            // data (empty bytes)
                );
                
                Swal.fire({
                    icon: 'info',
                    title: 'Transaction Submitted',
                    text: 'Please wait for confirmation...',
                    showConfirmButton: false,
                    timer: 3000
                });

                // Wait for transaction confirmation
                const receipt = await tx.wait();

                if (receipt.status === 1) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Loan Repaid Successfully!',
                        text: `Successfully repaid $${dollarAmount.toFixed(2)} USDC for ${borrowerAddress.slice(0, 6)}...${borrowerAddress.slice(-4)}`,
                        footer: `<a href="https://basescan.org/tx/${receipt.hash}" target="_blank">View on BaseScan</a>`
                    });

                    // Refresh loan balance to show updated amount
                    await updateLoanBalance();
                    
                    // Reset form
                    repayAmountInput.value = '';
                    usdcConversion.textContent = '0 USDC';
                    repayStepSection.style.display = 'none';
                    repayLoanBtn.style.display = 'none';
                    
                    // Refresh USDC balance
                    await updateBalance();
                } else {
                    throw new Error('Transaction failed');
                }

            } catch (error) {
                console.error('Repay error:', error);
                let errorMessage = 'Repayment transaction failed';
                
                if (error.code === 4001) {
                    errorMessage = 'Transaction rejected by user';
                } else if (error.message) {
                    errorMessage = error.message;
                }

                Swal.fire({
                    icon: 'error',
                    title: 'Repayment Failed',
                    text: errorMessage,
                });
            } finally {
                // Reset button state
                repayLoanBtn.disabled = false;
                repaySpinner.style.display = 'none';
                repayLoanBtn.innerHTML = '<span id="repay-spinner" class="spinner-border spinner-border-sm me-2" role="status" style="display: none;"></span>Repay Loan';
            }
        }

        // Disconnect Wallet
        function disconnectWallet() {
            provider = null;
            signer = null;
            userAddress = null;
            usdcContract = null;
            morphoContract = null;

            walletConnected.classList.add('d-none');
            walletDisconnected.classList.remove('d-none');
            repaymentSection.style.display = 'none';

            walletAddress.textContent = 'Not connected';
            networkStatus.textContent = 'Checking...';
            usdcBalance.textContent = 'Loading...';
            
            // Clear repayment form
            borrowerAddressInput.value = '';
            loanBalanceSection.style.display = 'none';
            loanBalance.textContent = 'Loading...';
            repayAmountInput.value = '';
            repayAmountInput.disabled = true;
            usdcConversion.textContent = '0 USDC';
            
            // Hide repay button and step
            repayStepSection.style.display = 'none';
            repayLoanBtn.style.display = 'none';
            repayLoanBtn.disabled = true;
        }

        // Handle account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    disconnectWallet();
                } else if (userAddress && accounts[0] !== userAddress) {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', () => {
                window.location.reload();
            });
        }
    </script>
</body>
</html>