<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repay Loan - Loan Safety Net</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.0/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem 0;
        }
        .param-value {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            word-break: break-all;
        }
        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .balance-display {
            font-weight: bold;
            color: #28a745;
        }
        .conversion-display {
            font-size: 0.9em;
            color: #6c757d;
        }
        .loading-spinner {
            display: none;
        }
        .step-card {
            transition: all 0.3s ease;
            border: 2px solid #e9ecef;
        }
        .step-card.step-active {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        .step-card.step-completed {
            border-color: #198754;
            background-color: #f8fff9;
        }
        .step-card.step-disabled {
            background-color: #f8f9fa;
            opacity: 0.6;
        }
        .step-header {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        .step-number.step-pending {
            background-color: #e9ecef;
            color: #6c757d;
        }
        .step-number.step-active {
            background-color: #0d6efd;
            color: white;
        }
        .step-number.step-completed {
            background-color: #198754;
            color: white;
        }
    </style>
</head>
<body>
    <div class="hero-section">
        <div class="container">
            <h1 class="display-5 text-center mb-3">Repay Loan</h1>
            <p class="lead text-center">Connect your wallet to repay this Morpho loan</p>
        </div>
    </div>

    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Repay Loan</li>
                    </ol>
                </nav>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0">Loan Details</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Loan Token:</label>
                                <div class="param-value" id="loan-token">Loading...</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Collateral Token:</label>
                                <div class="param-value" id="collateral-token">Loading...</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Oracle:</label>
                                <div class="param-value" id="oracle">Loading...</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">IRM:</label>
                                <div class="param-value" id="irm">Loading...</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">LLTV:</label>
                                <div class="param-value" id="lltv">Loading...</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Market ID:</label>
                                <div class="param-value" id="market-id">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Wallet Connection Section -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h3 class="mb-0">Wallet Connection</h3>
                    </div>
                    <div class="card-body">
                        <div id="wallet-disconnected" class="text-center">
                            <p class="text-muted mb-3">Connect your wallet to proceed with repayment</p>
                            <button id="connect-wallet-btn" class="btn btn-primary btn-lg">Connect Wallet</button>
                        </div>
                        <div id="wallet-connected" class="d-none">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Connected Address:</label>
                                    <div class="wallet-address" id="wallet-address">Not connected</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Network:</label>
                                    <div id="network-status">Checking...</div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">USDC Balance:</label>
                                    <div class="balance-display" id="usdc-balance">Loading...</div>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button id="disconnect-wallet-btn" class="btn btn-outline-secondary">Disconnect</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Repayment Section -->
                <div class="card mt-4" id="repayment-section" style="display: none;">
                    <div class="card-header">
                        <h3 class="mb-0">Repay Loan</h3>
                    </div>
                    <div class="card-body">
                        
                        <!-- Step 1: Enter Loan Address -->
                        <div class="card step-card step-active mb-4" id="step1-card">
                            <div class="card-body">
                                <div class="step-header mb-3">
                                    <div class="step-number step-active" id="step1-number">1</div>
                                    <div>Enter Loan Address</div>
                                </div>
                                <div class="mb-3">
                                    <label for="borrower-address" class="form-label fw-bold">Loan Address</label>
                                    <input type="text" class="form-control" id="borrower-address" placeholder="0x..." maxlength="42">
                                    <div class="form-text">Enter the Ethereum address that has the loan position</div>
                                </div>
                                <div class="mb-3" id="loan-balance-section" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="flex-grow-1">
                                            <label class="form-label fw-bold">Loan Balance:</label>
                                            <div class="balance-display text-muted" id="loan-balance-usdc">Loading...</div>
                                            <div class="small text-muted" id="loan-balance-shares">Loading shares...</div>
                                        </div>
                                        <button id="refresh-balance-btn" class="btn btn-sm btn-outline-primary">
                                            <span id="refresh-spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                                            Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Enter Repayment Amount -->
                        <div class="card step-card step-disabled mb-4" id="step2-card">
                            <div class="card-body">
                                <div class="step-header mb-3">
                                    <div class="step-number step-pending" id="step2-number">2</div>
                                    <div>Enter Repayment Amount</div>
                                </div>
                                <div class="mb-3">
                                    <label for="repay-amount" class="form-label fw-bold">Repayment Amount (USD)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="repay-amount" placeholder="0.00" min="0" step="0.01" disabled>
                                    </div>
                                    <div class="conversion-display mt-1" id="usdc-conversion">0 USDC</div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Approve USDC -->
                        <div class="card step-card step-disabled mb-4" id="step3-card">
                            <div class="card-body">
                                <div class="step-header mb-3">
                                    <div class="step-number step-pending" id="step3-number">3</div>
                                    <div>Approve USDC Spending</div>
                                </div>
                                <div class="mb-3">
                                    <div class="text-muted">Approve USDC spending to the Morpho contract before repaying the loan.</div>
                                </div>
                                <button id="approve-usdc-btn" class="btn btn-success btn-lg w-100" disabled>
                                    <span class="loading-spinner spinner-border spinner-border-sm me-2" role="status"></span>
                                    Approve USDC Spending
                                </button>
                            </div>
                        </div>

                        <!-- Step 4: Repay Loan -->
                        <div class="card step-card step-disabled mb-4" id="step4-card" style="display: none;">
                            <div class="card-body">
                                <div class="step-header mb-3">
                                    <div class="step-number step-pending" id="step4-number">4</div>
                                    <div>Repay Loan</div>
                                </div>
                                <div class="mb-3">
                                    <div class="text-muted">Execute the loan repayment with your approved USDC.</div>
                                </div>
                                <button id="repay-loan-btn" class="btn btn-primary btn-lg w-100" disabled>
                                    <span id="repay-spinner" class="spinner-border spinner-border-sm me-2" role="status" style="display: none;"></span>
                                    Repay Loan
                                </button>
                            </div>
                        </div>

                        <!-- Step 5: Completion -->
                        <div class="card step-card step-disabled mb-4" id="step5-card" style="display: none;">
                            <div class="card-body">
                                <div class="step-header mb-3">
                                    <div class="step-number step-pending" id="step5-number">5</div>
                                    <div>Repayment Complete!</div>
                                </div>
                                <div class="text-center">
                                    <div class="mb-3">
                                        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                                    </div>
                                    <h4 class="text-success mb-3">🎉 Congratulations!</h4>
                                    <p class="mb-3">Your loan repayment has been successfully completed.</p>
                                    
                                    <div class="alert alert-success">
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>Updated Loan Balance:</strong>
                                            </div>
                                            <div class="col-6">
                                                <div class="text-muted" id="final-loan-balance-usdc">Loading...</div>
                                                <div class="small text-muted" id="final-loan-balance-shares">Loading shares...</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button id="start-new-repayment-btn" class="btn btn-primary btn-lg">
                                        Start New Repayment
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            // Parse URL parameters and display them
            const urlParams = new URLSearchParams(window.location.search);
            
            $('#loan-token').text(urlParams.get('loan_token') || 'Not specified');
            $('#collateral-token').text(urlParams.get('collateral_token') || 'Not specified');
            $('#oracle').text(urlParams.get('oracle') || 'Not specified');
            $('#irm').text(urlParams.get('irm') || 'Not specified');
            $('#lltv').text(urlParams.get('lltv') || 'Not specified');
            $('#market-id').text(urlParams.get('market_id') || 'Not specified');

        // Web3 Configuration
        const BASE_CHAIN_ID = 8453;
        const USDC_ADDRESS = urlParams.get('loan_token') || '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';
        const MORPHO_ADDRESS = '0xBBBBBbbBBb9cC5e90e3b3Af64bdAF62C37EEFFCb';
        const HELPER_ADDRESS = '0x4900846ffafd75627d6e1de392a46042831a8962';
        const MARKET_ID = urlParams.get('market_id') || '0x9103c3b4e834476c9a62ea009ba2c884ee42e94e6e314a26f04d312434191836';
        const USDC_DECIMALS = 6;

        // Global variables
        let provider = null;
        let signer = null;
        let userAddress = null;
        let usdcContract = null;
        let morphoContract = null;
        let helperContract = null;

        // USDC ABI for approve and balanceOf functions
        const USDC_ABI = [
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function balanceOf(address account) external view returns (uint256)",
            "function decimals() external view returns (uint8)"
        ];

        // Morpho ABI for position and repay functions
        const MORPHO_ABI = [
            "function position(bytes32 id, address user) external view returns (uint256 supplyShares, uint128 borrowShares, uint128 collateral)",
            "function repay(tuple(address loanToken, address collateralToken, address oracle, address irm, uint256 lltv) marketParams, uint256 assets, uint256 shares, address onBehalf, bytes data) external returns (uint256, uint256)"
        ];

        // Helper contract ABI for borrowAssetsUser function
        const HELPER_ABI = [
            "function borrowAssetsUser(tuple(address loanToken, address collateralToken, address oracle, address irm, uint256 lltv) marketParams, address user) external view returns (uint256 totalBorrowAssets)"
        ];

        // jQuery DOM Elements
        const $connectWalletBtn = $('#connect-wallet-btn');
        const $disconnectWalletBtn = $('#disconnect-wallet-btn');
        const $walletDisconnected = $('#wallet-disconnected');
        const $walletConnected = $('#wallet-connected');
        const $walletAddress = $('#wallet-address');
        const $networkStatus = $('#network-status');
        const $usdcBalance = $('#usdc-balance');
        const $borrowerAddressInput = $('#borrower-address');
        const $loanBalanceSection = $('#loan-balance-section');
        const $loanBalanceUsdc = $('#loan-balance-usdc');
        const $loanBalanceShares = $('#loan-balance-shares');
        const $refreshBalanceBtn = $('#refresh-balance-btn');
        const $refreshSpinner = $('#refresh-spinner');
        const $repaymentSection = $('#repayment-section');
        const $repayAmountInput = $('#repay-amount');
        const $usdcConversion = $('#usdc-conversion');
        const $approveUsdcBtn = $('#approve-usdc-btn');
        const $repayLoanBtn = $('#repay-loan-btn');
        const $repaySpinner = $('#repay-spinner');
        
        // Step Elements
        const $step1Card = $('#step1-card');
        const $step1Number = $('#step1-number');
        const $step2Card = $('#step2-card');
        const $step2Number = $('#step2-number');
        const $step3Card = $('#step3-card');
        const $step3Number = $('#step3-number');
        const $step4Card = $('#step4-card');
        const $step4Number = $('#step4-number');
        const $step5Card = $('#step5-card');
        const $step5Number = $('#step5-number');
        const $finalLoanBalanceUsdc = $('#final-loan-balance-usdc');
        const $finalLoanBalanceShares = $('#final-loan-balance-shares');
        const $startNewRepaymentBtn = $('#start-new-repayment-btn');

        // Initialize wallet address if provided in URL
        const walletAddress = urlParams.get('wallet_address');
        if (walletAddress && walletAddress.length === 42 && walletAddress.startsWith('0x')) {
            $borrowerAddressInput.val(walletAddress);
        }

        // jQuery Event Listeners
        $connectWalletBtn.on('click', connectWallet);
        $disconnectWalletBtn.on('click', disconnectWallet);
        $borrowerAddressInput.on('input', handleAddressInput);
        $refreshBalanceBtn.on('click', refreshLoanBalance);
        $repayAmountInput.on('input', updateConversion);
        $approveUsdcBtn.on('click', approveUSDC);
        $repayLoanBtn.on('click', repayLoan);
        $startNewRepaymentBtn.on('click', startNewRepayment);

        // Trigger address input handling if wallet address was pre-populated
        if (walletAddress) {
            // Wait a bit for everything to initialize, then trigger address handling
            setTimeout(() => {
                handleAddressInput();
            }, 100);
        }

        // Step Management Functions
        function setStepState(stepNum, state) {
            const $card = $(`#step${stepNum}-card`);
            const $number = $(`#step${stepNum}-number`);
            
            // Remove all state classes
            $card.removeClass('step-active step-completed step-disabled');
            $number.removeClass('step-active step-completed step-pending');
            
            // Add new state classes
            switch (state) {
                case 'active':
                    $card.addClass('step-active');
                    $number.addClass('step-active');
                    break;
                case 'completed':
                    $card.addClass('step-completed');
                    $number.addClass('step-completed');
                    break;
                case 'disabled':
                    $card.addClass('step-disabled');
                    $number.addClass('step-pending');
                    break;
            }
        }

        function enableStep(stepNum) {
            setStepState(stepNum, 'active');
            
            // Enable relevant form elements
            switch (stepNum) {
                case 2:
                    $repayAmountInput.prop('disabled', false);
                    break;
                case 3:
                    $approveUsdcBtn.prop('disabled', false);
                    break;
                case 4:
                    $step4Card.show();
                    $repayLoanBtn.prop('disabled', false);
                    break;
                case 5:
                    $step5Card.show();
                    break;
            }
        }

        function completeStep(stepNum) {
            setStepState(stepNum, 'completed');
            
            // Auto-enable next step
            if (stepNum < 5) {
                enableStep(stepNum + 1);
            }
        }

        function resetSteps() {
            // Reset all steps to disabled except step 1
            setStepState(1, 'active');
            setStepState(2, 'disabled');
            setStepState(3, 'disabled');
            setStepState(4, 'disabled');
            setStepState(5, 'disabled');
            
            // Hide step 4 and 5, disable inputs
            $step4Card.hide();
            $step5Card.hide();
            $repayAmountInput.prop('disabled', true);
            $approveUsdcBtn.prop('disabled', true);
            $repayLoanBtn.prop('disabled', true);
        }

        function startNewRepayment() {
            // Clear form and reset steps
            $borrowerAddressInput.val('');
            $loanBalanceSection.hide();
            $loanBalanceUsdc.text('Loading...');
            $loanBalanceShares.text('Loading shares...');
            $repayAmountInput.val('');
            $usdcConversion.text('0 USDC');
            resetSteps();
        }

        // Connect Wallet Function
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    Swal.fire({
                        icon: 'error',
                        title: 'MetaMask Not Found',
                        text: 'Please install MetaMask to continue',
                    });
                    return;
                }

                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                // Check network
                const network = await provider.getNetwork();
                if (Number(network.chainId) !== BASE_CHAIN_ID) {
                    await switchToBase();
                    return;
                }

                // Initialize contracts
                usdcContract = new ethers.Contract(USDC_ADDRESS, USDC_ABI, signer);
                morphoContract = new ethers.Contract(MORPHO_ADDRESS, MORPHO_ABI, signer);
                helperContract = new ethers.Contract(HELPER_ADDRESS, HELPER_ABI, provider);

                // Update UI
                updateWalletUI();
                await updateBalance();

            } catch (error) {
                console.error('Wallet connection error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Connection Failed',
                    text: error.message || 'Failed to connect wallet',
                });
            }
        }

        // Switch to Base Network
        async function switchToBase() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x2105' }], // Base chainId in hex
                });
                // Retry connection after network switch
                setTimeout(connectWallet, 1000);
            } catch (error) {
                if (error.code === 4902) {
                    // Network not added, add it
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x2105',
                                chainName: 'Base',
                                nativeCurrency: {
                                    name: 'Ethereum',
                                    symbol: 'ETH',
                                    decimals: 18
                                },
                                rpcUrls: ['https://mainnet.base.org'],
                                blockExplorerUrls: ['https://basescan.org']
                            }]
                        });
                        setTimeout(connectWallet, 1000);
                    } catch (addError) {
                        console.error('Error adding Base network:', addError);
                        Swal.fire({
                            icon: 'error',
                            title: 'Network Error',
                            text: 'Please manually switch to Base network in your wallet',
                        });
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Network Switch Failed',
                        text: 'Please manually switch to Base network in your wallet',
                    });
                }
            }
        }

        // Update Wallet UI
        function updateWalletUI() {
            $walletDisconnected.addClass('d-none');
            $walletConnected.removeClass('d-none');
            $repaymentSection.show();
            
            const shortAddress = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
            $walletAddress.html(`<a href="https://basescan.org/address/${userAddress}" target="_blank" class="text-decoration-none">${shortAddress}</a>`);
            $networkStatus.html('<span class="badge bg-success">Base Network</span>');
        }

        // Update USDC Balance
        async function updateBalance() {
            try {
                const balance = await usdcContract.balanceOf(userAddress);
                const balanceFormatted = ethers.formatUnits(balance, USDC_DECIMALS);
                $usdcBalance.text(`$${parseFloat(balanceFormatted).toFixed(2)}`);
            } catch (error) {
                console.error('Balance update error:', error);
                $usdcBalance.text('Error loading balance');
            }
        }

        // Handle Address Input
        async function handleAddressInput() {
            const address = $borrowerAddressInput.val().trim();
            
            // Basic address validation
            if (address.length === 42 && address.startsWith('0x')) {
                try {
                    // Show loan balance section and fetch balance
                    $loanBalanceSection.show();
                    $loanBalanceUsdc.text('Loading...');
                    $loanBalanceShares.text('Loading shares...');
                    await updateLoanBalance(address);
                    
                    // Complete step 1 and enable step 2
                    completeStep(1);
                    updateConversion(); // Update button state
                } catch (error) {
                    console.error('Address validation error:', error);
                    $loanBalanceUsdc.text('Error loading loan balance');
                    $loanBalanceShares.text('Error loading shares');
                    updateConversion(); // Update button state
                }
            } else {
                // Hide loan balance section and reset steps
                $loanBalanceSection.hide();
                $repayAmountInput.val('');
                $usdcConversion.text('0 USDC');
                resetSteps();
                updateConversion(); // Update button state
            }
        }

        // Update Loan Balance
        async function updateLoanBalance(targetAddress = null) {
            try {
                const addressToCheck = targetAddress || $borrowerAddressInput.val().trim();
                
                if (!addressToCheck || !morphoContract || !helperContract) {
                    throw new Error('No address provided or contracts not initialized');
                }

                // Construct market parameters from URL params
                const marketParams = {
                    loanToken: urlParams.get('loan_token'),
                    collateralToken: urlParams.get('collateral_token'),
                    oracle: urlParams.get('oracle'),
                    irm: urlParams.get('irm'),
                    lltv: urlParams.get('lltv')
                };

                // Fetch both USDC balance and share balance in parallel
                const [usdcBalance, position] = await Promise.all([
                    helperContract.borrowAssetsUser(marketParams, addressToCheck),
                    morphoContract.position(MARKET_ID, addressToCheck)
                ]);

                // Format USDC balance (6 decimals)
                const usdcFormatted = ethers.formatUnits(usdcBalance, USDC_DECIMALS);
                $loanBalanceUsdc.text(`$${parseFloat(usdcFormatted).toFixed(2)}`);
                
                // Display share balance
                const borrowShares = position.borrowShares;
                $loanBalanceShares.text(`${borrowShares.toString()} shares`);
                
            } catch (error) {
                console.error('Loan balance update error:', error);
                $loanBalanceUsdc.text('Error loading loan balance');
                $loanBalanceShares.text('Error loading shares');
            }
        }

        // Refresh Loan Balance
        async function refreshLoanBalance() {
            try {
                $refreshSpinner.removeClass('d-none');
                $refreshBalanceBtn.prop('disabled', true);
                await updateLoanBalance();
                updateConversion(); // Update button state after refresh
            } catch (error) {
                console.error('Refresh error:', error);
            } finally {
                $refreshSpinner.addClass('d-none');
                $refreshBalanceBtn.prop('disabled', false);
            }
        }

        // Update Conversion Display
        function updateConversion() {
            const dollarAmount = parseFloat($repayAmountInput.val()) || 0;
            const usdcAmount = dollarAmount * Math.pow(10, USDC_DECIMALS);
            $usdcConversion.text(`${dollarAmount.toFixed(6)} USDC`);
            
            // Check if step 2 should be completed (valid amount entered)
            const hasValidAddress = $borrowerAddressInput.val().trim().length === 42 && $borrowerAddressInput.val().trim().startsWith('0x');
            const hasValidAmount = dollarAmount > 0;
            
            if (hasValidAddress && hasValidAmount) {
                // Complete step 2 and enable step 3 - allow progression even without loan balance loaded
                completeStep(2);
                
                // Enable approve button if wallet is connected
                if (userAddress) {
                    $approveUsdcBtn.prop('disabled', false);
                }
            } else if (hasValidAddress) {
                // Step 1 completed, step 2 active but not completed
                setStepState(2, 'active');
                $approveUsdcBtn.prop('disabled', true);
            }
        }

        // Approve USDC Spending
        async function approveUSDC() {
            try {
                const dollarAmount = parseFloat($repayAmountInput.val());
                if (!dollarAmount || dollarAmount <= 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Invalid Amount',
                        text: 'Please enter a valid repayment amount',
                    });
                    return;
                }

                // Convert to USDC units (6 decimals)
                const usdcAmount = ethers.parseUnits(dollarAmount.toString(), USDC_DECIMALS);

                // Show loading state
                $approveUsdcBtn.prop('disabled', true);
                $('.loading-spinner').show();
                $approveUsdcBtn.html('<span class="spinner-border spinner-border-sm me-2" role="status"></span>Approving...');

                // Execute approval transaction
                const tx = await usdcContract.approve(MORPHO_ADDRESS, usdcAmount);
                
                Swal.fire({
                    icon: 'info',
                    title: 'Transaction Submitted',
                    text: 'Please wait for confirmation...',
                    showConfirmButton: false,
                    timer: 3000
                });

                // Wait for transaction confirmation
                const receipt = await tx.wait();

                if (receipt.status === 1) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Approval Successful!',
                        text: `Successfully approved $${dollarAmount.toFixed(2)} USDC spending`,
                        footer: `<a href="https://basescan.org/tx/${receipt.hash}" target="_blank">View on BaseScan</a>`
                    });

                    // Complete step 3 and enable step 4
                    completeStep(3);
                } else {
                    throw new Error('Transaction failed');
                }

            } catch (error) {
                console.error('Approval error:', error);
                let errorMessage = 'Approval transaction failed';
                
                if (error.code === 4001) {
                    errorMessage = 'Transaction rejected by user';
                } else if (error.message) {
                    errorMessage = error.message;
                }

                Swal.fire({
                    icon: 'error',
                    title: 'Approval Failed',
                    text: errorMessage,
                });
            } finally {
                // Reset button state
                $approveUsdcBtn.prop('disabled', false);
                $approveUsdcBtn.html('Approve USDC Spending');
            }
        }

        // Repay Loan Function
        async function repayLoan() {
            try {
                const dollarAmount = parseFloat($repayAmountInput.val());
                const borrowerAddress = $borrowerAddressInput.val().trim();
                
                if (!dollarAmount || dollarAmount <= 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Invalid Amount',
                        text: 'Please enter a valid repayment amount',
                    });
                    return;
                }

                if (!borrowerAddress) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Missing Address',
                        text: 'Please enter the borrower address',
                    });
                    return;
                }

                // Convert to USDC units (6 decimals)
                const usdcAmount = ethers.parseUnits(dollarAmount.toString(), USDC_DECIMALS);

                // Show loading state
                $repayLoanBtn.prop('disabled', true);
                $repaySpinner.show();
                $repayLoanBtn.html('<span class="spinner-border spinner-border-sm me-2" role="status"></span>Repaying...');

                // Construct market parameters from URL params
                const marketParams = {
                    loanToken: urlParams.get('loan_token'),
                    collateralToken: urlParams.get('collateral_token'),
                    oracle: urlParams.get('oracle'),
                    irm: urlParams.get('irm'),
                    lltv: urlParams.get('lltv')
                };

                // Execute repay transaction
                const tx = await morphoContract.repay(
                    marketParams,    // MarketParams struct
                    usdcAmount,      // assets to repay
                    0,               // shares (0 means repay by assets amount)
                    borrowerAddress, // onBehalf (address to repay for)
                    "0x"            // data (empty bytes)
                );
                
                Swal.fire({
                    icon: 'info',
                    title: 'Transaction Submitted',
                    text: 'Please wait for confirmation...',
                    showConfirmButton: false,
                    timer: 3000
                });

                // Wait for transaction confirmation
                const receipt = await tx.wait();

                if (receipt.status === 1) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Loan Repaid Successfully!',
                        text: `Successfully repaid $${dollarAmount.toFixed(2)} USDC for ${borrowerAddress.slice(0, 6)}...${borrowerAddress.slice(-4)}`,
                        footer: `<a href="https://basescan.org/tx/${receipt.hash}" target="_blank">View on BaseScan</a>`
                    });

                    // Refresh loan balance to show updated amount
                    await updateLoanBalance();
                    
                    // Complete step 4 and show step 5 with final results
                    completeStep(4);
                    
                    // Update final loan balance display
                    const finalUsdcBalance = $loanBalanceUsdc.text();
                    const finalSharesBalance = $loanBalanceShares.text();
                    $finalLoanBalanceUsdc.text(finalUsdcBalance);
                    $finalLoanBalanceShares.text(finalSharesBalance);
                    
                    // Refresh USDC balance
                    await updateBalance();
                } else {
                    throw new Error('Transaction failed');
                }

            } catch (error) {
                console.error('Repay error:', error);
                let errorMessage = 'Repayment transaction failed';
                
                if (error.code === 4001) {
                    errorMessage = 'Transaction rejected by user';
                } else if (error.message) {
                    errorMessage = error.message;
                }

                Swal.fire({
                    icon: 'error',
                    title: 'Repayment Failed',
                    text: errorMessage,
                });
            } finally {
                // Reset button state
                $repayLoanBtn.prop('disabled', false);
                $repaySpinner.hide();
                $repayLoanBtn.html('<span id="repay-spinner" class="spinner-border spinner-border-sm me-2" role="status" style="display: none;"></span>Repay Loan');
            }
        }

        // Disconnect Wallet
        function disconnectWallet() {
            provider = null;
            signer = null;
            userAddress = null;
            usdcContract = null;
            morphoContract = null;
            helperContract = null;

            $walletConnected.addClass('d-none');
            $walletDisconnected.removeClass('d-none');
            $repaymentSection.hide();

            $walletAddress.text('Not connected');
            $networkStatus.text('Checking...');
            $usdcBalance.text('Loading...');
            
            // Clear repayment form and reset steps
            $borrowerAddressInput.val('');
            $loanBalanceSection.hide();
            $loanBalanceUsdc.text('Loading...');
            $loanBalanceShares.text('Loading shares...');
            $repayAmountInput.val('');
            $usdcConversion.text('0 USDC');
            resetSteps();
        }

        // Handle account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    disconnectWallet();
                } else if (userAddress && accounts[0] !== userAddress) {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', () => {
                window.location.reload();
            });
        }

        }); // End of document ready
    </script>
</body>
</html>